<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>TiendaSara — Carrito</title>
  <meta name="description" content="Revisa tu carrito, actualiza cantidades y procede al pago.">

  <!-- Bootstrap local -->
  <link href="assets/bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Íconos -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Estilos opcionales -->
  <link href="assets/css/style.css" rel="stylesheet">
  <!-- Favicon -->
  <link rel="icon" href="assets/img/favicon.png">
</head>
<body class="bg-light">

  <div class="bg-dark text-white text-center py-1 small">
    Envío gratis desde $899 MXN — <a class="link-light text-decoration-underline" href="#" title="Ver políticas">Ver políticas</a>
  </div>

  <!-- HEADER -->
  <header class="border-bottom bg-white">
    <nav class="navbar navbar-expand-lg navbar-light bg-white container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
        <img src="assets/img/logo-tienda.png" alt="Logo Tienda Sara" width="36" height="36">
        <span class="fw-bold">TiendaSara</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain" aria-controls="navMain" aria-expanded="false" aria-label="Abrir menú">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="productos.html">Productos</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="carrito.html">Carrito <span class="badge text-bg-primary" id="miniCount">0</span></a></li>
        </ul>
      </div>
    </nav>
  </header>

  <!-- CONTENIDO -->
  <main class="container my-4">
    <h1 class="h4 mb-4">Tu carrito</h1>

    <div class="row g-4">
      <!-- Lista -->
      <section class="col-12 col-lg-8">
        <div id="estadoVacio" class="alert alert-info d-none">Tu carrito está vacío. <a href="productos.html" class="alert-link">Explora productos</a>.</div>

        <div class="bg-white rounded-4 shadow-sm p-3" id="lista">
          <!-- Filas se inyectan por JS -->
        </div>
      </section>

      <!-- Resumen -->
      <aside class="col-12 col-lg-4">
        <div class="bg-white rounded-4 shadow-sm p-3">
          <h6 class="mb-3">Resumen del pedido</h6>

          <div class="d-flex justify-content-between small mb-1">
            <span>Subtotal</span>
            <span id="lblSubtotal">$0.00</span>
          </div>

          <div class="d-flex justify-content-between small mb-1">
            <span>Envío</span>
            <span id="lblEnvio">$0.00</span>
          </div>

          <div class="d-flex justify-content-between small mb-1">
            <span>Impuestos (IVA 16%)</span>
            <span id="lblImpuestos">$0.00</span>
          </div>

          <div class="d-flex justify-content-between small mb-1 text-success d-none" id="rowDescuento">
            <span>Descuento (cupón)</span>
            <span id="lblDescuento">-$0.00</span>
          </div>

          <hr>
          <div class="d-flex justify-content-between">
            <strong>Total</strong>
            <strong id="lblTotal">$0.00</strong>
          </div>

          <!-- Cupón -->
          <div class="mt-3">
            <label class="form-label small">Cupón de descuento</label>
            <div class="input-group input-group-sm">
              <input id="cupon" type="text" class="form-control" placeholder="Ej. SARA20">
              <button id="btnCupon" class="btn btn-outline-secondary">Aplicar</button>
            </div>
            <div class="form-text">Usa <strong>SARA20</strong> para 20% de descuento.</div>
          </div>

          <div class="d-grid gap-2 mt-3">
            <a href="productos.html" class="btn btn-outline-secondary">Seguir comprando</a>
            <button class="btn btn-primary">Proceder al pago</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Footer sencillo -->
  <footer class="bg-dark text-white mt-5">
    <div class="container py-4 text-center small">© 2025 TiendaSara.</div>
  </footer>

  <script src="assets/bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const $ = (s,ctx=document)=>ctx.querySelector(s);
    const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));

    function money(n){ return n.toLocaleString('es-MX',{style:'currency', currency:'MXN'}); }

    function loadItems(){
      return JSON.parse(localStorage.getItem('cartItems')||'[]');
    }
    function saveItems(items){
      localStorage.setItem('cartItems', JSON.stringify(items));
    }
    function updateMiniCount(){
      const items = loadItems();
      const count = items.reduce((a,b)=>a + (b.qty||0), 0);
      localStorage.setItem('cartCount', count);
      const badge = $('#miniCount'); if (badge) badge.textContent = count;
    }

    function render(){
      const cont = $('#lista');
      cont.innerHTML = '';
      const items = loadItems();

      if(items.length===0){
        $('#estadoVacio').classList.remove('d-none');
      }else{
        $('#estadoVacio').classList.add('d-none');
      }

      items.forEach((it,idx)=>{
        const row = document.createElement('div');
        row.className = 'd-flex flex-column flex-md-row align-items-center gap-3 border-bottom py-3';

        row.innerHTML = `
          <img src="${it.img}" class="rounded" style="width:72px;height:72px;object-fit:cover" alt="${it.name}">
          <div class="me-auto">
            <div class="fw-semibold">${it.name}</div>
            <div class="small text-secondary">Precio unitario: ${money(it.price)}</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <input type="number" min="1" step="1" value="${it.qty||1}" class="form-control form-control-sm" style="width:80px" data-idx="${idx}">
            <div class="text-nowrap fw-semibold" style="width:110px;text-align:right">${money(it.price * (it.qty||1))}</div>
            <button class="btn btn-sm btn-outline-danger" data-del="${idx}" title="Eliminar">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;
        cont.appendChild(row);
      });

      calcular();
      updateMiniCount();

      // Eventos qty/eliminar
      $$('input[type="number"][data-idx]').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const i = Number(inp.dataset.idx);
          const items = loadItems();
          items[i].qty = Math.max(1, Number(inp.value||1));
          saveItems(items);
          render();
        });
      });
      $$('button[data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = Number(btn.dataset.del);
          const items = loadItems();
          items.splice(i,1);
          saveItems(items);
          render();
        });
      });
    }

    let descuento = 0; // monto negativo aplicado por cupón
    function calcular(){
      const items = loadItems();
      const subtotal = items.reduce((a,b)=>a + b.price*(b.qty||1), 0);
      const envio = subtotal>=899 || subtotal===0 ? 0 : 99; // coincide con banner
      const impuestos = subtotal * 0.16;
      const total = Math.max(0, subtotal + envio + impuestos + descuento);

      $('#lblSubtotal').textContent = money(subtotal);
      $('#lblEnvio').textContent = money(envio);
      $('#lblImpuestos').textContent = money(impuestos);
      $('#lblTotal').textContent = money(total);

      if(descuento<0){
        $('#rowDescuento').classList.remove('d-none');
        $('#lblDescuento').textContent = money(Math.abs(descuento));
      }else{
        $('#rowDescuento').classList.add('d-none');
      }
    }

    // Cupón
    $('#btnCupon').addEventListener('click', ()=>{
      const code = ($('#cupon').value||'').trim().toUpperCase();
      const items = loadItems();
      const subtotal = items.reduce((a,b)=>a + b.price*(b.qty||1), 0);
      if(code==='SARA20' && subtotal>0){
        descuento = -(subtotal * 0.20);
      }else{
        descuento = 0;
      }
      calcular();
    });

    // Inicial
    render();
  </script>
</body>
</html>
